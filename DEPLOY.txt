# GCP 프로젝트 설정
export PROJECT_ID="<PROJECT_ID>"
gcloud config set project "$PROJECT_ID"

# 필요한 API 활성화
gcloud services enable aiplatform.googleapis.com secretmanager.googleapis.com compute.googleapis.com logging.googleapis.com

# VM 생성 (WSL 줄바꿈 문제 시 dos2unix 처리)
sed -i 's/\r$//' deploy/create_vm.sh
bash deploy/create_vm.sh

# VM 접속
gcloud compute ssh crypto-trading-vm --zone=us-central1-a

# VM 내부: 기본 패키지 설치
sudo apt update
sudo apt install -y python3.11 python3.11-venv python3-pip git

# VM 내부: 코드 배포
git clone <REPO_URL> /opt/crypto_trading_system
cd /opt/crypto_trading_system
python3.11 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# VM 내부: 환경변수 파일 작성
cp .env.example .env
nano .env

# 로컬/Cloud Shell: Secret Manager 등록
for NAME in SUPABASE_URL SUPABASE_KEY TELEGRAM_API_ID TELEGRAM_API_HASH TELEGRAM_PHONE TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID PERPLEXITY_API_KEY NEO4J_URI NEO4J_PASSWORD MILVUS_URI MILVUS_TOKEN; do read -s SECRET_VALUE && echo -n "$SECRET_VALUE" | gcloud secrets create "$NAME" --replication-policy=automatic --data-file=- && unset SECRET_VALUE; done

# 로컬/Cloud Shell: VM 서비스 계정에 Secret 접근 권한 부여
gcloud projects add-iam-policy-binding "$PROJECT_ID" --member="serviceAccount:crypto-trading-sa@${PROJECT_ID}.iam.gserviceaccount.com" --role="roles/secretmanager.secretAccessor"

# VM 내부: Telethon 세션 1회 생성
cd /opt/crypto_trading_system
source venv/bin/activate
python -c "from telethon.sync import TelegramClient; import os; from dotenv import load_dotenv; load_dotenv(); c=TelegramClient('telegram_session', int(os.getenv('TELEGRAM_API_ID')), os.getenv('TELEGRAM_API_HASH')); c.start(phone=os.getenv('TELEGRAM_PHONE')); c.disconnect(); print('telegram session ok')"

# VM 내부: 1회 실행 테스트
source venv/bin/activate
python scheduler.py

# VM 내부: systemd 서비스 등록
sudo cp deploy/scheduler.service /etc/systemd/system/scheduler.service
sudo systemctl daemon-reload
sudo systemctl enable scheduler
sudo systemctl start scheduler

# VM 내부: 상태/로그 확인
sudo systemctl status scheduler
sudo journalctl -u scheduler -f

# 운영 자주 쓰는 명령어
sudo systemctl restart scheduler
gcloud compute instances list
gcloud compute ssh crypto-trading-vm --zone=us-central1-a

# MCP 서버 수동 실행
source venv/bin/activate
python mcp_server/server.py
